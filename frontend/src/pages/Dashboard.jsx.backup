/**
 * Dashboard - Premium Analytics & Management Hub
 * Features: Analytics, Plan Management, Usage Tracking, Activity Timeline
 */

import React, { useState, useEffect, useMemo, useCallback, memo } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';
import { Skeleton } from '@/components/ui/skeleton';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { useAuth } from '@/contexts/AuthContext';
import { useSubscription } from '@/contexts/SubscriptionContext';
import { supabase } from '@/lib/supabase';
import { 
  Heart, Plus, Settings, LogOut, MoreVertical, ExternalLink, Copy, Trash2, Loader2, 
  Code, Layout, Palette, Eye, Star, TrendingUp, Users, MessageSquare, Sparkles, 
  ArrowUpRight, Clock, CheckCircle2, Video, Image, Zap, Crown, BarChart3, 
  Folder, RefreshCw, Search, Filter, Grid3X3, List, ChevronRight, Bell, 
  Activity, Target, Award, Flame, ArrowRight, Calendar, CreditCard, Shield,
  AlertTriangle, XCircle, Check, ChevronDown, ChevronUp, Download, Share2,
  TrendingDown, AlertCircle, Info, X, Rocket, CalendarDays,
  Receipt, Gauge, PieChart, Timer, Inbox, Eye as EyeIcon
} from 'lucide-react';
import { toast } from 'sonner';
import { v4 as uuidv4 } from 'uuid';
import ProfileModal from '@/components/ProfileModal';
import UserProfileImage from '@/components/UserProfileImage';

// Animation variants
const fadeInUp = {
  initial: { opacity: 0, y: 20 },
  animate: { opacity: 1, y: 0 },
  exit: { opacity: 0, y: -10 }
};

const staggerContainer = {
  animate: {
    transition: { staggerChildren: 0.05 }
  }
};

const scaleIn = {
  initial: { opacity: 0, scale: 0.95 },
  animate: { opacity: 1, scale: 1 },
  exit: { opacity: 0, scale: 0.95 }
};

// Mini Bar Chart Component
const MiniBarChart = memo(({ data, height = 60 }) => {
  const maxValue = Math.max(...data.map(d => d.value), 1);
  return (
    <div className="flex items-end justify-between gap-1 h-full" style={{ height }}>
      {data.map((item, i) => (
        <div key={i} className="flex-1 flex flex-col items-center gap-1">
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: `${(item.value / maxValue) * 100}%` }}
            transition={{ duration: 0.5, delay: i * 0.05 }}
            className="w-full rounded-t-sm min-h-[4px]"
            style={{ minHeight: item.value > 0 ? '8px' : '4px', background: 'linear-gradient(to top, #8b5cf6, #a78bfa)' }}
          />
          <span className="text-[10px] text-muted-foreground">{item.label}</span>
        </div>
      ))}
    </div>
  );
});

// Circular Progress Component
const CircularProgress = memo(({ value, max, size = 80, strokeWidth = 8, label }) => {
  const percentage = max > 0 && max !== -1 ? Math.min((value / max) * 100, 100) : 0;
  const radius = (size - strokeWidth) / 2;
  const circumference = radius * 2 * Math.PI;
  const offset = circumference - (percentage / 100) * circumference;
  const getColor = () => percentage >= 90 ? '#ef4444' : percentage >= 75 ? '#f59e0b' : '#8b5cf6';
  
  return (
    <div className="flex flex-col items-center gap-2">
      <div className="relative" style={{ width: size, height: size }}>
        <svg width={size} height={size} className="rotate-[-90deg]">
          <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke="currentColor" strokeWidth={strokeWidth} className="text-slate-200 dark:text-slate-700" />
          <motion.circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={getColor()} strokeWidth={strokeWidth} strokeLinecap="round" strokeDasharray={circumference} initial={{ strokeDashoffset: circumference }} animate={{ strokeDashoffset: offset }} transition={{ duration: 1 }} />
        </svg>
        <div className="absolute inset-0 flex flex-col items-center justify-center">
          <span className="text-lg font-bold">{value}</span>
          <span className="text-[10px] text-muted-foreground">/ {max === -1 ? 'âˆž' : max}</span>
        </div>
      </div>
      {label && <span className="text-xs font-medium text-center">{label}</span>}
    </div>
  );
});

// Sparkline Component
const SparkLine = memo(({ data, color = "#8b5cf6", height = 40 }) => {
  if (!data || data.length < 2) return null;
  const maxVal = Math.max(...data, 1), minVal = Math.min(...data, 0), range = maxVal - minVal || 1;
  const points = data.map((v, i) => `${(i / (data.length - 1)) * 100},${100 - ((v - minVal) / range) * 100}`).join(' ');
  return (
    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full" style={{ height }}>
      <motion.polyline fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" points={points} initial={{ pathLength: 0 }} animate={{ pathLength: 1 }} transition={{ duration: 1 }} />
    </svg>
  );
});

// Usage Card Component
const UsageCard = memo(({ icon: Icon, title, used, limit, isPro = false }) => {
  const percentage = limit > 0 && limit !== -1 ? Math.round((used / limit) * 100) : 0;
  const isUnlimited = limit === -1 || limit === Infinity;
  const isNearLimit = percentage >= 80, isAtLimit = percentage >= 100;
  
  return (
    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }}>
      <Card className={`border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg overflow-hidden ${isAtLimit ? 'ring-2 ring-red-500/50' : ''}`}>
        {isAtLimit && <div className="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-red-500 to-orange-500" />}
        <CardContent className="p-4">
          <div className="flex items-start justify-between mb-3">
            <div className="p-2 rounded-xl bg-gradient-to-br from-violet-500 to-violet-600"><Icon className="w-4 h-4 text-white" /></div>
            {isPro && <Badge className="bg-gradient-to-r from-amber-500 to-orange-500 text-white text-[10px] border-0"><Crown className="w-3 h-3 mr-1" /> PRO</Badge>}
          </div>
          <h3 className="font-semibold text-sm mb-1">{title}</h3>
          <div className="flex items-baseline gap-1 mb-2">
            <span className="text-2xl font-bold">{used}</span>
            <span className="text-sm text-muted-foreground">/ {isUnlimited ? 'âˆž' : limit}</span>
          </div>
          {!isUnlimited && (
            <>
              <Progress value={Math.min(percentage, 100)} className={`h-2 ${isAtLimit ? 'bg-red-100' : isNearLimit ? 'bg-amber-100' : ''}`} />
              <div className="flex justify-between items-center mt-2">
                <span className={`text-xs ${isAtLimit ? 'text-red-600' : isNearLimit ? 'text-amber-600' : 'text-muted-foreground'}`}>
                  {isAtLimit ? 'Limit reached' : isNearLimit ? 'Almost full' : `${percentage}% used`}
                </span>
              </div>
            </>
          )}
        </CardContent>
      </Card>
    </motion.div>
  );
});

// Memoized Stats Card Component
const StatCard = memo(({ icon: Icon, title, value, subtitle, trend, color, delay = 0 }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    transition={{ duration: 0.4, delay }}
    whileHover={{ y: -2, transition: { duration: 0.2 } }}
  >
    <Card className="relative overflow-hidden border-0 bg-white/70 dark:bg-slate-800/70 backdrop-blur-xl shadow-lg shadow-slate-200/50 dark:shadow-slate-900/50 hover:shadow-xl transition-all duration-300">
      <div className={`absolute inset-0 bg-gradient-to-br ${color} opacity-5`} />
      <div className={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br ${color} opacity-10 blur-2xl rounded-full -translate-y-1/2 translate-x-1/2`} />
      <CardContent className="p-5 relative">
        <div className="flex items-start justify-between">
          <div className="space-y-2">
            <p className="text-sm font-medium text-muted-foreground">{title}</p>
            <p className="text-3xl font-bold tracking-tight">{value}</p>
            {subtitle && (
              <p className="text-xs text-muted-foreground flex items-center gap-1">
                {trend === 'up' && <TrendingUp className="w-3 h-3 text-emerald-500" />}
                {subtitle}
              </p>
            )}
          </div>
          <div className={`p-3 rounded-xl bg-gradient-to-br ${color} shadow-lg`}>
            <Icon className="w-5 h-5 text-white" />
          </div>
        </div>
      </CardContent>
    </Card>
  </motion.div>
));

// Memoized Space Card Component
const SpaceCard = memo(({ space, index, onNavigate, onCopyLink, onOpenEmbed, onDelete }) => {
  const testimonialCount = space.testimonials?.[0]?.count || 0;
  const hasTestimonials = testimonialCount > 0;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4, delay: index * 0.05 }}
      whileHover={{ y: -4, transition: { duration: 0.2 } }}
      className="h-full"
    >
      <Card 
        className="group h-full relative overflow-hidden border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer"
        onClick={() => onNavigate(space.id)}
      >
        {/* Gradient accent top border */}
        <div className="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-violet-500 via-purple-500 to-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity" />
        
        {/* Decorative blob */}
        <div className="absolute -top-12 -right-12 w-32 h-32 bg-gradient-to-br from-violet-400/20 to-purple-400/20 rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
        
        <CardHeader className="pb-3 relative">
          <div className="flex items-start justify-between gap-2">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-indigo-500 flex items-center justify-center shadow-lg shadow-violet-500/25">
                  <Folder className="w-5 h-5 text-white" />
                </div>
                <div className="flex-1 min-w-0">
                  <CardTitle className="text-base font-semibold truncate group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors">
                    {space.space_name}
                  </CardTitle>
                  <CardDescription className="text-xs truncate">
                    /{space.slug}
                  </CardDescription>
                </div>
              </div>
            </div>
            <DropdownMenu>
              <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                <Button 
                  variant="ghost" 
                  size="icon" 
                  className="h-8 w-8 opacity-0 group-hover:opacity-100 transition-all hover:bg-slate-100 dark:hover:bg-slate-700"
                >
                  <MoreVertical className="w-4 h-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end" className="w-48">
                <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onCopyLink(space.slug); }}>
                  <Copy className="w-4 h-4 mr-2" />
                  Copy submit link
                </DropdownMenuItem>
                <DropdownMenuItem onClick={(e) => { e.stopPropagation(); window.open(`/submit/${space.slug}`, '_blank'); }}>
                  <ExternalLink className="w-4 h-4 mr-2" />
                  Open form
                </DropdownMenuItem>
                <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onOpenEmbed(space.id); }}>
                  <Code className="w-4 h-4 mr-2" />
                  Embed Widget
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem 
                  onClick={(e) => { e.stopPropagation(); onDelete(space.id); }}
                  className="text-red-600 focus:text-red-600 focus:bg-red-50 dark:focus:bg-red-950"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </CardHeader>
        
        <CardContent className="pt-0 relative">
          {/* Stats row */}
          <div className="flex items-center gap-4 py-3 border-t border-slate-100 dark:border-slate-700/50">
            <div className="flex items-center gap-1.5 text-sm">
              <MessageSquare className="w-4 h-4 text-violet-500" />
              <span className="font-medium">{testimonialCount}</span>
              <span className="text-muted-foreground text-xs">testimonials</span>
            </div>
          </div>
          
          {/* Quick actions */}
          <div className="flex gap-2 mt-2">
            <Button
              variant="secondary"
              size="sm"
              className="flex-1 h-9 text-xs bg-slate-100/80 dark:bg-slate-700/50 hover:bg-violet-100 dark:hover:bg-violet-900/30 border-0"
              onClick={(e) => { e.stopPropagation(); onCopyLink(space.slug); }}
            >
              <Copy className="w-3.5 h-3.5 mr-1.5" />
              Copy Link
            </Button>
            <Button
              variant="secondary"
              size="sm"
              className="h-9 px-3 bg-slate-100/80 dark:bg-slate-700/50 hover:bg-violet-100 dark:hover:bg-violet-900/30 border-0"
              onClick={(e) => { e.stopPropagation(); window.open(`/submit/${space.slug}`, '_blank'); }}
            >
              <ExternalLink className="w-3.5 h-3.5" />
            </Button>
          </div>
        </CardContent>
        
        {/* Hover arrow indicator */}
        <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
          <div className="w-8 h-8 rounded-full bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center">
            <ChevronRight className="w-4 h-4 text-violet-600" />
          </div>
        </div>
      </Card>
    </motion.div>
  );
});

// Create New Space Card
const CreateSpaceCard = memo(({ onClick, delay = 0 }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    transition={{ duration: 0.4, delay }}
    whileHover={{ y: -4, transition: { duration: 0.2 } }}
    className="h-full"
  >
    <Card 
      className="h-full min-h-[200px] border-2 border-dashed border-violet-200 dark:border-violet-800/50 hover:border-violet-400 dark:hover:border-violet-600 bg-gradient-to-br from-violet-50/50 to-purple-50/50 dark:from-violet-950/20 dark:to-purple-950/20 hover:from-violet-100/50 hover:to-purple-100/50 dark:hover:from-violet-900/30 dark:hover:to-purple-900/30 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center group"
      onClick={onClick}
    >
      <CardContent className="text-center py-8">
        <motion.div 
          className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-violet-500 to-indigo-500 flex items-center justify-center shadow-xl shadow-violet-500/25 group-hover:shadow-violet-500/40 transition-shadow"
          whileHover={{ scale: 1.05, rotate: 5 }}
          transition={{ type: "spring", stiffness: 400 }}
        >
          <Plus className="w-8 h-8 text-white" />
        </motion.div>
        <p className="font-semibold text-slate-700 dark:text-slate-300 group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors">
          Create New Space
        </p>
        <p className="text-xs text-muted-foreground mt-1">Start collecting testimonials</p>
      </CardContent>
    </Card>
  </motion.div>
));

// Quick Action Button
const QuickAction = memo(({ icon: Icon, label, onClick, color = "violet" }) => (
  <motion.button
    whileHover={{ scale: 1.02 }}
    whileTap={{ scale: 0.98 }}
    onClick={onClick}
    className={`flex items-center gap-3 p-4 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50 hover:border-${color}-300 dark:hover:border-${color}-700 shadow-sm hover:shadow-lg transition-all w-full text-left group`}
  >
    <div className={`w-10 h-10 rounded-xl bg-gradient-to-br from-${color}-500 to-${color}-600 flex items-center justify-center shadow-lg`}>
      <Icon className="w-5 h-5 text-white" />
    </div>
    <div className="flex-1 min-w-0">
      <p className="font-medium text-sm text-slate-700 dark:text-slate-200 group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors">
        {label}
      </p>
    </div>
    <ArrowRight className="w-4 h-4 text-slate-400 group-hover:text-violet-500 group-hover:translate-x-1 transition-all" />
  </motion.button>
));

const Dashboard = () => {
  const { user, profile, signOut, loading: authLoading, refreshProfile } = useAuth();
  const { 
    subscription, 
    loading: subLoading, 
    quotas, 
    planHierarchy, 
    effectivePlan,
    refreshSubscription 
  } = useSubscription() || {};
  
  const [spaces, setSpaces] = useState([]);
  const [allTestimonials, setAllTestimonials] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isProfileOpen, setIsProfileOpen] = useState(false);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [newSpaceName, setNewSpaceName] = useState('');
  const [creating, setCreating] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [timeFilter, setTimeFilter] = useState('7d');
  const [cancelDialogOpen, setCancelDialogOpen] = useState(false);
  const [cancelling, setCancelling] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  
  // Embed Modal State
  const [embedDialogOpen, setEmbedDialogOpen] = useState(false);
  const [selectedSpaceId, setSelectedSpaceId] = useState('');
  const [embedTheme, setEmbedTheme] = useState('light');
  const [embedLayout, setEmbedLayout] = useState('grid');

  const navigate = useNavigate();

  useEffect(() => {
    if (!authLoading && !user) {
      navigate('/login');
    }
  }, [user, authLoading, navigate]);

  // Fetch all data including testimonials for stats
  const fetchAllData = useCallback(async () => {
    if (!user) return;
    setLoading(true);
    try {
      const { data: spacesData, error: spacesError } = await supabase
        .from('spaces')
        .select('*, testimonials(count)')
        .eq('owner_id', user.id)
        .order('created_at', { ascending: false });

      if (spacesError) throw spacesError;
      setSpaces(spacesData || []);

      const { data: testimonialsData, error: testimonialsError } = await supabase
        .from('testimonials')
        .select('id, status, video_url, photo_url, created_at, space_id, name')
        .in('space_id', (spacesData || []).map(s => s.id))
        .order('created_at', { ascending: false })
        .limit(500);

      if (!testimonialsError) {
        setAllTestimonials(testimonialsData || []);
      }
    } catch (error) {
      console.error('Error fetching data:', error);
      toast.error('Failed to load dashboard data', { description: 'Please try refreshing the page.' });
    } finally {
      setLoading(false);
    }
  }, [user]);

  useEffect(() => {
    if (user) fetchAllData();
  }, [user, fetchAllData]);

  const handleRefresh = async () => {
    setRefreshing(true);
    try {
      await fetchAllData();
      await refreshSubscription?.();
      toast.success('Dashboard refreshed!');
    } catch (error) {
      toast.error('Failed to refresh');
    } finally {
      setRefreshing(false);
    }
  };

  // Enhanced stats with time filtering
  const stats = useMemo(() => {
    const now = new Date();
    let filterDate = new Date();
    switch (timeFilter) {
      case '24h': filterDate.setDate(filterDate.getDate() - 1); break;
      case '7d': filterDate.setDate(filterDate.getDate() - 7); break;
      case '30d': filterDate.setDate(filterDate.getDate() - 30); break;
      case '90d': filterDate.setDate(filterDate.getDate() - 90); break;
      default: filterDate.setDate(filterDate.getDate() - 7);
    }
    
    const filteredTestimonials = allTestimonials.filter(t => new Date(t.created_at) >= filterDate);
    const totalTestimonials = allTestimonials.length;
    const approvedTestimonials = allTestimonials.filter(t => t.status === 'approved').length;
    const pendingTestimonials = allTestimonials.filter(t => t.status === 'pending').length;
    const videoTestimonials = allTestimonials.filter(t => t.video_url).length;
    const recentTestimonials = filteredTestimonials.length;
    
    // Growth rate calculation
    const prevFilterDate = new Date(filterDate);
    const periodLength = now - filterDate;
    prevFilterDate.setTime(prevFilterDate.getTime() - periodLength);
    const prevTestimonials = allTestimonials.filter(
      t => new Date(t.created_at) >= prevFilterDate && new Date(t.created_at) < filterDate
    ).length;
    const growthRate = prevTestimonials > 0 
      ? Math.round(((recentTestimonials - prevTestimonials) / prevTestimonials) * 100) 
      : recentTestimonials > 0 ? 100 : 0;
    
    return {
      totalSpaces: spaces.length,
      totalTestimonials,
      approvedTestimonials,
      pendingTestimonials,
      videoTestimonials,
      recentTestimonials,
      growthRate,
      approvalRate: totalTestimonials > 0 ? Math.round((approvedTestimonials / totalTestimonials) * 100) : 0
    };
  }, [spaces, allTestimonials, timeFilter]);

  // Chart data for weekly testimonials
  const chartData = useMemo(() => {
    const days = timeFilter === '24h' ? 24 : timeFilter === '7d' ? 7 : timeFilter === '30d' ? 30 : 12;
    const isHourly = timeFilter === '24h';
    const data = [];
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      if (isHourly) {
        date.setHours(date.getHours() - i);
        const count = allTestimonials.filter(t => {
          const tDate = new Date(t.created_at);
          return tDate.getHours() === date.getHours() && tDate.getDate() === date.getDate();
        }).length;
        data.push({ label: date.getHours() + 'h', value: count });
      } else {
        date.setDate(date.getDate() - i);
        const count = allTestimonials.filter(t => new Date(t.created_at).toDateString() === date.toDateString()).length;
        const label = timeFilter === '7d' ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()] : date.getDate().toString();
        data.push({ label, value: count });
      }
    }
    return data;
  }, [allTestimonials, timeFilter]);

  const sparklineData = useMemo(() => chartData.map(d => d.value), [chartData]);

  // Recent activity
  const recentActivity = useMemo(() => {
    return allTestimonials.slice(0, 5).map(t => ({
      id: t.id,
      type: t.status === 'approved' ? 'testimonial_approved' : 'testimonial_received',
      title: t.status === 'approved' ? 'Testimonial Approved' : 'New Testimonial',
      description: `From ${t.name || 'Anonymous'}`,
      time: getTimeAgo(new Date(t.created_at)),
      date: new Date(t.created_at)
    }));
  }, [allTestimonials]);

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  }

  // Filter spaces based on search
  const filteredSpaces = useMemo(() => {
    if (!searchQuery.trim()) return spaces;
    const query = searchQuery.toLowerCase();
    return spaces.filter(space => 
      space.space_name.toLowerCase().includes(query) ||
      space.slug.toLowerCase().includes(query)
    );
  }, [spaces, searchQuery]);

  const generateSlug = useCallback((name) => {
    return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + uuidv4().slice(0, 6);
  }, []);

  const createSpace = async (e) => {
    e.preventDefault();
    if (!newSpaceName.trim()) return;
    
    if (spaces.length >= (quotas?.maxSpaces || 1)) {
      toast.error('Space limit reached', { description: 'Upgrade your plan to create more spaces.' });
      return;
    }

    setCreating(true);
    try {
      const slug = generateSlug(newSpaceName);
      const { data, error } = await supabase
        .from('spaces')
        .insert({
          id: uuidv4(),
          owner_id: user.id,
          space_name: newSpaceName,
          slug: slug,
          header_title: `Share your experience with ${newSpaceName}`,
          custom_message: 'We appreciate your feedback! Please take a moment to share your experience.',
          collect_star_rating: true,
          created_at: new Date().toISOString(),
        })
        .select()
        .single();

      if (error) throw error;

      setSpaces([data, ...spaces]);
      setCreateDialogOpen(false);
      setNewSpaceName('');
      
      toast.success('Space created successfully! ðŸŽ‰', {
        description: 'Your new space is ready to collect testimonials.',
      });
      
      navigate(`/dashboard/${data.id}`);
    } catch (error) {
      console.error('Error creating space:', error);
      toast.error('Failed to create space', {
        description: 'Please try again.',
      });
    } finally {
      setCreating(false);
    }
  };

  const deleteSpace = async (spaceId) => {
    if (!window.confirm('Are you sure you want to delete this space? All testimonials will be lost.')) {
      return;
    }

    try {
      const { error } = await supabase
        .from('spaces')
        .delete()
        .eq('id', spaceId);

      if (error) throw error;

      setSpaces(spaces.filter(s => s.id !== spaceId));
      toast.success('Space deleted', {
        description: 'The space has been removed.',
      });
    } catch (error) {
      console.error('Error deleting space:', error);
      toast.error('Failed to delete space', {
        description: 'Please try again.',
      });
    }
  };

  const copySubmitLink = useCallback((slug) => {
    const link = `${window.location.origin}/submit/${slug}`;
    navigator.clipboard.writeText(link);
    toast.success('Link copied to clipboard! ðŸ“‹', {
      description: 'Share this link with your clients.',
    });
  }, []);

  // Embed Logic
  const openEmbedModal = useCallback((spaceId) => {
    setSelectedSpaceId(spaceId);
    setEmbedTheme('light');
    setEmbedLayout('grid');
    setEmbedDialogOpen(true);
  }, []);

  const getPreviewUrl = useCallback(() => {
    const origin = window.location.origin;
    const queryParams = [];
    if (embedTheme !== 'light') queryParams.push(`theme=${embedTheme}`);
    if (embedLayout !== 'grid') queryParams.push(`layout=${embedLayout}`);
    
    const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
    return `${origin}/embed/${selectedSpaceId}${queryString}`;
  }, [selectedSpaceId, embedTheme, embedLayout]);

  const getEmbedCode = useCallback(() => {
    const origin = window.location.origin;
    return `<script src="${origin}/embed.js" data-space-id="${selectedSpaceId}" data-theme="${embedTheme}" data-layout="${embedLayout}"></script>`;
  }, [selectedSpaceId, embedTheme, embedLayout]);

  const copyEmbedCode = useCallback(() => {
    navigator.clipboard.writeText(getEmbedCode());
    toast.success('Embed code copied! ðŸš€', {
      description: 'Paste this into your website HTML.',
    });
  }, [getEmbedCode]);

  const handleSignOut = async () => {
    await signOut();
    navigate('/');
  };

  // Loading state
  if (authLoading || subLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-violet-50 via-white to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950">
        <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="flex flex-col items-center gap-4">
          <div className="relative">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-indigo-500 flex items-center justify-center shadow-2xl shadow-violet-500/30">
              <Star className="w-8 h-8 text-white animate-pulse" />
            </div>
            <Loader2 className="absolute -bottom-1 -right-1 w-6 h-6 text-violet-600 animate-spin" />
          </div>
          <p className="text-sm text-muted-foreground">Loading dashboard...</p>
        </motion.div>
      </div>
    );
  }

  if (!user) return null;

  const handleCancelSubscription = async () => {
    setCancelling(true);
    try {
      toast.info('Cancellation request submitted', { description: 'You will receive a confirmation email shortly.' });
      setCancelDialogOpen(false);
    } catch (error) {
      toast.error('Failed to cancel subscription');
    } finally {
      setCancelling(false);
    }
  };

  // Billing card component
  const BillingCard = () => {
    const plan = subscription?.plans;
    const isFreePlan = subscription?.plan_id === 'free';
    const currentPeriodEnd = subscription?.current_period_end ? new Date(subscription.current_period_end) : null;
    const daysRemaining = currentPeriodEnd ? Math.max(0, Math.ceil((currentPeriodEnd - new Date()) / (1000 * 60 * 60 * 24))) : null;
    const getPlanGradient = () => subscription?.plan_id === 'pro' ? 'from-amber-500 to-orange-500' : subscription?.plan_id === 'starter' ? 'from-violet-500 to-indigo-500' : 'from-slate-500 to-slate-600';
    const PlanIcon = subscription?.plan_id === 'pro' ? Crown : subscription?.plan_id === 'starter' ? Rocket : Zap;
    
    return (
      <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-xl overflow-hidden">
        <div className={`h-2 bg-gradient-to-r ${getPlanGradient()}`} />
        <CardHeader className="pb-4">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-3">
              <div className={`p-3 rounded-xl bg-gradient-to-br ${getPlanGradient()} shadow-lg`}><PlanIcon className="w-6 h-6 text-white" /></div>
              <div>
                <CardTitle className="text-lg">{plan?.name || 'Free Tier'}</CardTitle>
                <CardDescription>{isFreePlan ? 'Basic features' : 'Full access'}</CardDescription>
              </div>
            </div>
            <Badge variant={subscription?.status === 'active' ? 'default' : 'secondary'} className="capitalize">{subscription?.status || 'active'}</Badge>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {!isFreePlan && currentPeriodEnd && (
            <div className="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 space-y-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-sm text-muted-foreground"><CalendarDays className="w-4 h-4" /><span>Next billing</span></div>
                <span className="font-medium">{currentPeriodEnd.toLocaleDateString()}</span>
              </div>
              {daysRemaining !== null && (
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2 text-sm text-muted-foreground"><Timer className="w-4 h-4" /><span>Days left</span></div>
                  <Badge variant={daysRemaining <= 7 ? 'destructive' : 'outline'}>{daysRemaining} days</Badge>
                </div>
              )}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-sm text-muted-foreground"><CreditCard className="w-4 h-4" /><span>Amount</span></div>
                <span className="font-semibold text-lg">${plan?.amount_usd || 0}<span className="text-sm text-muted-foreground">/mo</span></span>
              </div>
            </div>
          )}
          <div className="flex flex-col sm:flex-row gap-2">
            {isFreePlan ? (
              <Button className="flex-1 bg-gradient-to-r from-violet-600 to-indigo-600" onClick={() => navigate('/pricing')}><Rocket className="w-4 h-4 mr-2" /> Upgrade Plan</Button>
            ) : (
              <>
                <Button variant="outline" className="flex-1" onClick={() => toast.info('Opening billing portal...')}><Receipt className="w-4 h-4 mr-2" /> Manage Billing</Button>
                <Button variant="ghost" className="text-red-600 hover:bg-red-50" onClick={() => setCancelDialogOpen(true)}><XCircle className="w-4 h-4 mr-2" /> Cancel</Button>
              </>
            )}
          </div>
        </CardContent>
      </Card>
    );
  };

  // Activity item component
  const ActivityItem = ({ activity, isLast }) => (
    <div className="flex gap-3">
      <div className="flex flex-col items-center">
        <div className={`p-2 rounded-full ${activity.type === 'testimonial_approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'}`}>
          {activity.type === 'testimonial_approved' ? <CheckCircle2 className="w-4 h-4" /> : <MessageSquare className="w-4 h-4" />}
        </div>
        {!isLast && <div className="w-px h-full bg-slate-200 dark:bg-slate-700 mt-2" />}
      </div>
      <div className="flex-1 pb-4">
        <p className="text-sm font-medium">{activity.title}</p>
        <p className="text-xs text-muted-foreground">{activity.description}</p>
        <p className="text-xs text-muted-foreground mt-1">{activity.time}</p>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-violet-50/30 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950">
      {/* Animated Background Blobs */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <motion.div
          animate={{
            scale: [1, 1.2, 1],
            x: [0, 30, 0],
            y: [0, -20, 0],
          }}
          transition={{
            duration: 20,
            repeat: Infinity,
            repeatType: 'reverse',
            ease: 'easeInOut',
          }}
          className="absolute -top-40 -right-40 w-[500px] h-[500px] rounded-full bg-gradient-to-br from-violet-200/40 via-purple-200/30 to-indigo-200/40 dark:from-violet-900/20 dark:via-purple-900/15 dark:to-indigo-900/20 blur-3xl"
        />
        <motion.div
          animate={{
            scale: [1, 1.1, 1],
            x: [0, -20, 0],
            y: [0, 30, 0],
          }}
          transition={{
            duration: 25,
            repeat: Infinity,
            repeatType: 'reverse',
            ease: 'easeInOut',
            delay: 3,
          }}
          className="absolute -bottom-40 -left-40 w-[400px] h-[400px] rounded-full bg-gradient-to-tr from-indigo-200/30 via-violet-200/20 to-purple-200/30 dark:from-indigo-900/15 dark:via-violet-900/10 dark:to-purple-900/15 blur-3xl"
        />
      </div>

      {/* Header */}
      <header className="sticky top-0 z-50 border-b border-slate-200/50 dark:border-slate-800/50 bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl">
        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex h-16 items-center justify-between">
            {/* Logo */}
            <Link to="/dashboard" className="flex items-center gap-2.5 group">
              <motion.div 
                whileHover={{ scale: 1.05, rotate: 5 }}
                transition={{ type: "spring", stiffness: 400 }}
                className="w-10 h-10 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-500/25"
              >
                <Star className="w-5 h-5 text-white" />
              </motion.div>
              <span className="text-xl font-bold bg-gradient-to-r from-violet-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent hidden sm:block">
                TrustWall
              </span>
            </Link>

            {/* Right Section */}
            <div className="flex items-center gap-3">
              {/* Refresh Button */}
              <Button
                variant="ghost"
                size="icon"
                onClick={handleRefresh}
                disabled={refreshing}
                className="w-9 h-9 rounded-xl hover:bg-violet-100 dark:hover:bg-violet-900/30"
              >
                <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />
              </Button>

              {/* Profile Dropdown */}
              <div className="relative">
                <motion.button 
                  whileHover={{ scale: 1.02 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => setIsProfileOpen(!isProfileOpen)}
                  className="flex items-center gap-2 p-1.5 pr-3 rounded-xl bg-slate-100/80 dark:bg-slate-800/80 hover:bg-slate-200/80 dark:hover:bg-slate-700/80 transition-colors"
                >
                  <UserProfileImage 
                    src={profile?.avatar_url} 
                    alt={profile?.full_name || "User"} 
                    className="w-8 h-8 rounded-lg border-2 border-white dark:border-slate-700 shadow-sm"
                    iconClassName="w-4 h-4"
                  />
                  <span className="text-sm font-medium text-slate-700 dark:text-slate-200 hidden sm:block max-w-[120px] truncate">
                    {profile?.full_name?.split(' ')[0] || 'User'}
                  </span>
                </motion.button>
                
                <AnimatePresence>
                  {isProfileOpen && (
                    <>
                      <motion.div 
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 z-40" 
                        onClick={() => setIsProfileOpen(false)} 
                      />
                      <motion.div 
                        initial={{ opacity: 0, y: 8, scale: 0.96 }}
                        animate={{ opacity: 1, y: 0, scale: 1 }}
                        exit={{ opacity: 0, y: 8, scale: 0.96 }}
                        transition={{ type: "spring", stiffness: 400, damping: 25 }}
                        className="absolute right-0 top-12 w-64 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200/50 dark:border-slate-700/50 z-50 overflow-hidden"
                      >
                        {/* Profile Header */}
                        <div className="p-4 bg-gradient-to-br from-violet-500 to-indigo-600">
                          <div className="flex items-center gap-3">
                            <UserProfileImage 
                              src={profile?.avatar_url} 
                              alt={profile?.full_name || "User"} 
                              className="w-12 h-12 rounded-xl border-2 border-white/30 shadow-lg"
                              iconClassName="w-6 h-6"
                            />
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-semibold text-white truncate">
                                {profile?.full_name || 'User'}
                              </p>
                              <p className="text-xs text-white/70 truncate">
                                {user?.email}
                              </p>
                            </div>
                          </div>
                          {subscription?.plans?.name && (
                            <Badge className="mt-3 bg-white/20 text-white border-0 text-xs">
                              <Crown className="w-3 h-3 mr-1" />
                              {subscription.plans.name}
                            </Badge>
                          )}
                        </div>
                        
                        {/* Menu Items */}
                        <div className="p-2">
                          <button 
                            onClick={() => { setIsProfileOpen(false); setIsProfileModalOpen(true); }}
                            className="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-violet-50 dark:hover:bg-violet-900/20 hover:text-violet-600 dark:hover:text-violet-400 rounded-xl transition-all text-left group"
                          >
                            <div className="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center group-hover:bg-violet-100 dark:group-hover:bg-violet-900/50 transition-colors">
                              <Settings className="w-4 h-4" />
                            </div>
                            Profile Settings
                          </button>
                          <button 
                            onClick={() => navigate('/pricing')}
                            className="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-violet-50 dark:hover:bg-violet-900/20 hover:text-violet-600 dark:hover:text-violet-400 rounded-xl transition-all text-left group"
                          >
                            <div className="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center group-hover:bg-violet-100 dark:group-hover:bg-violet-900/50 transition-colors">
                              <Zap className="w-4 h-4" />
                            </div>
                            Upgrade Plan
                          </button>
                          <div className="my-2 mx-3 h-px bg-slate-100 dark:bg-slate-700" />
                          <button 
                            onClick={handleSignOut} 
                            className="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all text-left group"
                          >
                            <div className="w-8 h-8 rounded-lg bg-red-50 dark:bg-red-900/30 flex items-center justify-center">
                              <LogOut className="w-4 h-4" />
                            </div>
                            Sign Out
                          </button>
                        </div>
                      </motion.div>
                    </>
                  )}
                </AnimatePresence>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-6 relative">
        {/* Welcome Section */}
        <motion.div {...fadeInUp} className="mb-6">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">
                Welcome back, {profile?.full_name?.split(' ')[0] || 'there'}! ðŸ‘‹
              </h1>
              <p className="text-slate-600 dark:text-slate-400 mt-1">Here's your testimonial performance overview</p>
            </div>
            <div className="flex items-center gap-2">
              <Select value={timeFilter} onValueChange={setTimeFilter}>
                <SelectTrigger className="w-28 h-9 text-xs"><SelectValue /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="24h">24 hours</SelectItem>
                  <SelectItem value="7d">7 days</SelectItem>
                  <SelectItem value="30d">30 days</SelectItem>
                  <SelectItem value="90d">90 days</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </motion.div>

        {/* Tabs */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50 p-1 rounded-xl w-full sm:w-auto">
            <TabsTrigger value="overview" className="rounded-lg text-xs sm:text-sm gap-1.5"><BarChart3 className="w-4 h-4" /> <span className="hidden sm:inline">Overview</span></TabsTrigger>
            <TabsTrigger value="spaces" className="rounded-lg text-xs sm:text-sm gap-1.5"><Folder className="w-4 h-4" /> <span className="hidden sm:inline">Spaces</span></TabsTrigger>
            <TabsTrigger value="billing" className="rounded-lg text-xs sm:text-sm gap-1.5"><CreditCard className="w-4 h-4" /> <span className="hidden sm:inline">Billing</span></TabsTrigger>
          </TabsList>

          {/* OVERVIEW TAB */}
          <TabsContent value="overview" className="space-y-6">
            {/* Stats Grid */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
              <motion.div {...fadeInUp} transition={{ delay: 0.1 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg overflow-hidden">
                  <CardContent className="p-4 sm:p-5">
                    <div className="flex items-start justify-between mb-3">
                      <div className="p-2 sm:p-3 rounded-xl bg-gradient-to-br from-violet-500 to-indigo-500"><MessageSquare className="w-4 h-4 sm:w-5 sm:h-5 text-white" /></div>
                      {stats.growthRate !== 0 && <Badge variant={stats.growthRate > 0 ? 'default' : 'secondary'} className="text-[10px] h-5">{stats.growthRate > 0 ? <TrendingUp className="w-3 h-3 mr-1" /> : <TrendingDown className="w-3 h-3 mr-1" />}{stats.growthRate > 0 ? '+' : ''}{stats.growthRate}%</Badge>}
                    </div>
                    <p className="text-xs text-muted-foreground mb-1">Total Testimonials</p>
                    <p className="text-2xl sm:text-3xl font-bold">{stats.totalTestimonials}</p>
                    <div className="mt-3 h-10"><SparkLine data={sparklineData} /></div>
                  </CardContent>
                </Card>
              </motion.div>
              <motion.div {...fadeInUp} transition={{ delay: 0.15 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg">
                  <CardContent className="p-4 sm:p-5">
                    <div className="flex items-start justify-between mb-3">
                      <div className="p-2 sm:p-3 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600"><CheckCircle2 className="w-4 h-4 sm:w-5 sm:h-5 text-white" /></div>
                      <Badge variant="outline" className="text-[10px] h-5 text-emerald-600 border-emerald-200">{stats.approvalRate}%</Badge>
                    </div>
                    <p className="text-xs text-muted-foreground mb-1">Approved</p>
                    <p className="text-2xl sm:text-3xl font-bold">{stats.approvedTestimonials}</p>
                    <p className="text-xs text-muted-foreground mt-2">Approval rate</p>
                  </CardContent>
                </Card>
              </motion.div>
              <motion.div {...fadeInUp} transition={{ delay: 0.2 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg">
                  <CardContent className="p-4 sm:p-5">
                    <div className="flex items-start justify-between mb-3">
                      <div className="p-2 sm:p-3 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500"><Clock className="w-4 h-4 sm:w-5 sm:h-5 text-white" /></div>
                      {stats.pendingTestimonials > 0 && <Badge variant="destructive" className="text-[10px] h-5 animate-pulse">Action needed</Badge>}
                    </div>
                    <p className="text-xs text-muted-foreground mb-1">Pending Review</p>
                    <p className="text-2xl sm:text-3xl font-bold">{stats.pendingTestimonials}</p>
                    {stats.pendingTestimonials > 0 && <Button variant="link" size="sm" className="p-0 h-auto text-xs mt-2" onClick={() => spaces[0] && navigate(`/dashboard/${spaces[0].id}`)}>Review now <ArrowRight className="w-3 h-3 ml-1" /></Button>}
                  </CardContent>
                </Card>
              </motion.div>
              <motion.div {...fadeInUp} transition={{ delay: 0.25 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg">
                  <CardContent className="p-4 sm:p-5">
                    <div className="flex items-start justify-between mb-3">
                      <div className="p-2 sm:p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500"><Video className="w-4 h-4 sm:w-5 sm:h-5 text-white" /></div>
                    </div>
                    <p className="text-xs text-muted-foreground mb-1">Video Testimonials</p>
                    <p className="text-2xl sm:text-3xl font-bold">{stats.videoTestimonials}</p>
                    <p className="text-xs text-muted-foreground mt-2">Collected</p>
                  </CardContent>
                </Card>
              </motion.div>
            </div>

            {/* Charts & Activity Row */}
            <div className="grid lg:grid-cols-3 gap-4 sm:gap-6">
              <motion.div {...fadeInUp} transition={{ delay: 0.3 }} className="lg:col-span-2">
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg h-full">
                  <CardHeader className="pb-2">
                    <div className="flex items-center justify-between">
                      <div><CardTitle className="text-base">Testimonials Over Time</CardTitle><CardDescription className="text-xs">New testimonials received</CardDescription></div>
                      <Badge variant="outline" className="text-xs">{stats.recentTestimonials} in period</Badge>
                    </div>
                  </CardHeader>
                  <CardContent className="pt-2">
                    <div className="h-32 sm:h-40"><MiniBarChart data={chartData} height={chartData.length > 12 ? 100 : 120} /></div>
                  </CardContent>
                </Card>
              </motion.div>
              <motion.div {...fadeInUp} transition={{ delay: 0.35 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg h-full">
                  <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><Activity className="w-4 h-4 text-violet-500" /> Recent Activity</CardTitle></CardHeader>
                  <CardContent className="pt-2">
                    {recentActivity.length > 0 ? recentActivity.map((activity, i) => <ActivityItem key={activity.id} activity={activity} isLast={i === recentActivity.length - 1} />) : <div className="text-center py-8 text-muted-foreground text-sm">No recent activity</div>}
                  </CardContent>
                </Card>
              </motion.div>
            </div>

            {/* Plan Usage */}
            <motion.div {...fadeInUp} transition={{ delay: 0.4 }}>
              <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg">
                <CardHeader className="pb-2">
                  <div className="flex items-center justify-between">
                    <div><CardTitle className="text-base flex items-center gap-2"><Gauge className="w-4 h-4 text-violet-500" /> Plan Usage</CardTitle><CardDescription className="text-xs">Track your resource consumption</CardDescription></div>
                    <Button variant="outline" size="sm" className="h-8 text-xs" onClick={() => navigate('/pricing')}><Zap className="w-3 h-3 mr-1.5" /> Upgrade</Button>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    <UsageCard icon={Folder} title="Spaces" used={stats.totalSpaces} limit={quotas?.maxSpaces || 1} />
                    <UsageCard icon={MessageSquare} title="Text Testimonials" used={allTestimonials.filter(t => !t.video_url).length} limit={quotas?.maxTextTestimonials || 10} />
                    <UsageCard icon={Video} title="Video Testimonials" used={stats.videoTestimonials} limit={quotas?.maxVideos || 0} isPro={quotas?.maxVideos === 0} />
                    <UsageCard icon={Award} title="Current Plan" used={planHierarchy?.isFree ? 0 : planHierarchy?.isStarter ? 1 : 2} limit={2} />
                  </div>
                </CardContent>
              </Card>
            </motion.div>

            {/* Quick Actions */}
            <motion.div {...fadeInUp} transition={{ delay: 0.45 }}>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <Button variant="outline" className="h-auto py-4 flex-col gap-2 bg-white/80 dark:bg-slate-800/80" onClick={() => setCreateDialogOpen(true)}><Plus className="w-5 h-5 text-violet-500" /><span className="text-xs">New Space</span></Button>
                <Button variant="outline" className="h-auto py-4 flex-col gap-2 bg-white/80 dark:bg-slate-800/80" onClick={() => spaces[0] && navigate(`/dashboard/${spaces[0].id}`)}><Inbox className="w-5 h-5 text-blue-500" /><span className="text-xs">View Inbox</span></Button>
                <Button variant="outline" className="h-auto py-4 flex-col gap-2 bg-white/80 dark:bg-slate-800/80" onClick={() => navigate('/pricing')}><Zap className="w-5 h-5 text-amber-500" /><span className="text-xs">Upgrade</span></Button>
                <Button variant="outline" className="h-auto py-4 flex-col gap-2 bg-white/80 dark:bg-slate-800/80" onClick={handleRefresh} disabled={refreshing}><RefreshCw className={`w-5 h-5 text-emerald-500 ${refreshing ? 'animate-spin' : ''}`} /><span className="text-xs">Refresh</span></Button>
              </div>
            </motion.div>
          </TabsContent>

          {/* SPACES TAB */}
          <TabsContent value="spaces" className="space-y-6">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div><h2 className="text-xl font-bold">Your Spaces</h2><p className="text-sm text-muted-foreground">{stats.totalSpaces} / {quotas?.maxSpaces || 1} spaces used</p></div>
              <div className="flex items-center gap-2">
                <div className="relative flex-1 sm:flex-none"><Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" /><Input placeholder="Search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="pl-9 w-full sm:w-56 h-9 text-sm" /></div>
                <Button onClick={() => setCreateDialogOpen(true)} disabled={stats.totalSpaces >= (quotas?.maxSpaces || 1)} className="bg-gradient-to-r from-violet-600 to-indigo-600"><Plus className="w-4 h-4 mr-1.5" /> New</Button>
              </div>
            </div>
            {loading ? (
              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">{[1,2,3].map(i => <Card key={i} className="border-0 bg-white/80 dark:bg-slate-800/80"><CardHeader><Skeleton className="h-10 w-10 rounded-xl" /><Skeleton className="h-4 w-32 mt-2" /></CardHeader><CardContent><Skeleton className="h-8 w-full" /></CardContent></Card>)}</div>
            ) : filteredSpaces.length === 0 ? (
              <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl">
                <CardContent className="py-16 text-center">
                  <motion.div initial={{ scale: 0.8 }} animate={{ scale: 1 }} className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-violet-500 to-indigo-600 flex items-center justify-center shadow-xl"><Sparkles className="w-10 h-10 text-white" /></motion.div>
                  <h3 className="text-xl font-bold mb-2">{searchQuery ? 'No spaces found' : 'Create your first space'}</h3>
                  <p className="text-muted-foreground mb-6 max-w-sm mx-auto">{searchQuery ? 'Try a different search term' : 'Spaces help you organize testimonials by project or client'}</p>
                  {!searchQuery && <Button onClick={() => setCreateDialogOpen(true)} className="bg-gradient-to-r from-violet-600 to-indigo-600"><Plus className="w-4 h-4 mr-2" /> Create Space</Button>}
                </CardContent>
              </Card>
            ) : (
              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredSpaces.map((space, index) => <SpaceCard key={space.id} space={space} index={index} onNavigate={(id) => navigate(`/dashboard/${id}`)} onCopyLink={copySubmitLink} onOpenEmbed={openEmbedModal} onDelete={deleteSpace} />)}
                {stats.totalSpaces < (quotas?.maxSpaces || 1) && <CreateSpaceCard onClick={() => setCreateDialogOpen(true)} delay={filteredSpaces.length * 0.05} />}
              </div>
            )}
          </TabsContent>

          {/* BILLING TAB */}
          <TabsContent value="billing" className="space-y-6">
            <div className="grid lg:grid-cols-2 gap-6">
              <motion.div {...fadeInUp}><BillingCard /></motion.div>
              <motion.div {...fadeInUp} transition={{ delay: 0.1 }}>
                <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg h-full">
                  <CardHeader><CardTitle className="text-base flex items-center gap-2"><PieChart className="w-4 h-4 text-violet-500" /> Usage Summary</CardTitle><CardDescription className="text-xs">Your current resource usage</CardDescription></CardHeader>
                  <CardContent>
                    <div className="flex items-center justify-around gap-4">
                      <CircularProgress value={stats.totalSpaces} max={quotas?.maxSpaces || 1} label="Spaces" size={90} />
                      <CircularProgress value={allTestimonials.filter(t => !t.video_url).length} max={quotas?.maxTextTestimonials || 10} label="Testimonials" size={90} />
                      <CircularProgress value={stats.videoTestimonials} max={quotas?.maxVideos || 1} label="Videos" size={90} />
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            </div>
            <motion.div {...fadeInUp} transition={{ delay: 0.2 }}>
              <Card className="border-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl shadow-lg">
                <CardHeader><CardTitle className="text-base">Compare Plans</CardTitle><CardDescription className="text-xs">See what you get with each plan</CardDescription></CardHeader>
                <CardContent>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead><tr className="border-b"><th className="text-left py-3 px-2 font-medium">Feature</th><th className="text-center py-3 px-2 font-medium">Free</th><th className="text-center py-3 px-2 font-medium"><Badge variant="default" className="bg-violet-600">Starter</Badge></th><th className="text-center py-3 px-2 font-medium"><Badge className="bg-gradient-to-r from-amber-500 to-orange-500 border-0">Pro</Badge></th></tr></thead>
                      <tbody>
                        <tr className="border-b"><td className="py-3 px-2">Spaces</td><td className="text-center py-3 px-2">1</td><td className="text-center py-3 px-2">3</td><td className="text-center py-3 px-2">10</td></tr>
                        <tr className="border-b"><td className="py-3 px-2">Text Testimonials</td><td className="text-center py-3 px-2">10</td><td className="text-center py-3 px-2">500</td><td className="text-center py-3 px-2">âˆž</td></tr>
                        <tr className="border-b"><td className="py-3 px-2">Video Testimonials</td><td className="text-center py-3 px-2"><X className="w-4 h-4 mx-auto text-red-500" /></td><td className="text-center py-3 px-2">20</td><td className="text-center py-3 px-2">100</td></tr>
                        <tr className="border-b"><td className="py-3 px-2">Remove Branding</td><td className="text-center py-3 px-2"><X className="w-4 h-4 mx-auto text-red-500" /></td><td className="text-center py-3 px-2"><Check className="w-4 h-4 mx-auto text-emerald-500" /></td><td className="text-center py-3 px-2"><Check className="w-4 h-4 mx-auto text-emerald-500" /></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-4 text-center"><Button onClick={() => navigate('/pricing')} className="bg-gradient-to-r from-violet-600 to-indigo-600">View Full Comparison <ArrowRight className="w-4 h-4 ml-2" /></Button></div>
                </CardContent>
              </Card>
            </motion.div>
          </TabsContent>
        </Tabs>
      </main>

      {/* Create Space Dialog */}
      <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader><DialogTitle className="text-xl flex items-center gap-2"><Plus className="w-5 h-5 text-violet-500" /> Create New Space</DialogTitle><DialogDescription>A space is a dedicated collection point for testimonials</DialogDescription></DialogHeader>
          <form onSubmit={createSpace} className="space-y-4">
            <div className="space-y-2"><Label htmlFor="spaceName">Space Name</Label><Input id="spaceName" placeholder="e.g., My Awesome Product" value={newSpaceName} onChange={(e) => setNewSpaceName(e.target.value)} className="h-11" required /></div>
            <div className="flex flex-col-reverse sm:flex-row gap-2 pt-2">
              <Button type="button" variant="outline" onClick={() => setCreateDialogOpen(false)} className="flex-1">Cancel</Button>
              <Button type="submit" disabled={creating} className="flex-1 bg-gradient-to-r from-violet-600 to-indigo-600">{creating && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}Create Space</Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Cancel Subscription Dialog */}
      <Dialog open={cancelDialogOpen} onOpenChange={setCancelDialogOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader><DialogTitle className="flex items-center gap-2 text-red-600"><AlertTriangle className="w-5 h-5" /> Cancel Subscription</DialogTitle><DialogDescription>Are you sure you want to cancel? You'll lose access to premium features at the end of your billing period.</DialogDescription></DialogHeader>
          <Alert variant="destructive"><AlertCircle className="w-4 h-4" /><AlertTitle>What you'll lose</AlertTitle><AlertDescription className="text-xs mt-2"><ul className="list-disc list-inside space-y-1"><li>Video testimonials</li><li>Remove branding option</li><li>Premium themes</li><li>Priority support</li></ul></AlertDescription></Alert>
          <DialogFooter className="flex-col-reverse sm:flex-row gap-2"><Button variant="outline" onClick={() => setCancelDialogOpen(false)}>Keep Subscription</Button><Button variant="destructive" onClick={handleCancelSubscription} disabled={cancelling}>{cancelling && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}Yes, Cancel</Button></DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Embed Code Dialog */}
      <Dialog open={embedDialogOpen} onOpenChange={setEmbedDialogOpen}>
        <DialogContent className="max-w-5xl max-h-[90vh] sm:h-[85vh] flex flex-col p-0 gap-0 overflow-hidden">
          <div className="p-4 sm:p-6 border-b bg-white dark:bg-slate-900">
            <DialogHeader>
              <DialogTitle className="text-lg sm:text-xl flex items-center gap-2">
                <Code className="w-5 h-5 text-violet-600" />
                Embed Wall of Love
              </DialogTitle>
              <DialogDescription className="text-sm">
                Customize your widget and copy the code to your website.
              </DialogDescription>
            </DialogHeader>
          </div>
          
          <div className="flex-1 overflow-hidden flex flex-col lg:flex-row">
            {/* Left Column: Settings & Code */}
            <div className="w-full lg:w-[400px] border-b lg:border-b-0 lg:border-r p-4 sm:p-6 overflow-y-auto space-y-5 bg-slate-50/50 dark:bg-slate-900/50">
              
              {/* Settings */}
              <div className="space-y-4">
                <div className="space-y-2">
                  <Label className="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex items-center gap-2">
                    <Layout className="w-3 h-3" /> Layout
                  </Label>
                  <div className="grid grid-cols-3 gap-2">
                    {['grid', 'masonry', 'carousel'].map((l) => (
                      <motion.button 
                        key={l}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                        onClick={() => setEmbedLayout(l)}
                        className={`px-3 py-2.5 text-sm rounded-xl border transition-all ${
                          embedLayout === l 
                            ? 'bg-violet-100 border-violet-500 text-violet-700 font-medium dark:bg-violet-900/40 dark:text-violet-300 shadow-sm' 
                            : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700'
                        }`}
                      >
                        {l.charAt(0).toUpperCase() + l.slice(1)}
                      </motion.button>
                    ))}
                  </div>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex items-center gap-2">
                    <Palette className="w-3 h-3" /> Theme
                  </Label>
                  <div className="grid grid-cols-2 gap-2">
                    {['light', 'dark'].map((t) => (
                      <motion.button 
                        key={t}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                        onClick={() => setEmbedTheme(t)}
                        className={`px-3 py-2.5 text-sm rounded-xl border transition-all ${
                          embedTheme === t
                            ? 'bg-violet-100 border-violet-500 text-violet-700 font-medium dark:bg-violet-900/40 dark:text-violet-300 shadow-sm' 
                            : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700'
                        }`}
                      >
                        {t.charAt(0).toUpperCase() + t.slice(1)}
                      </motion.button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="h-px bg-slate-200 dark:bg-slate-700" />

              {/* Code Snippet */}
              <div className="space-y-3">
                <Label className="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex items-center gap-2">
                  <Code className="w-3 h-3" /> Embed Code
                </Label>
                <div className="relative group">
                  <motion.div 
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    className="absolute right-2 top-2 z-10"
                  >
                    <Button 
                      size="sm" 
                      onClick={copyEmbedCode} 
                      className="h-8 shadow-lg bg-violet-600 hover:bg-violet-700 text-white text-xs gap-1.5"
                    >
                      <Copy className="w-3.5 h-3.5" /> Copy Code
                    </Button>
                  </motion.div>
                  <pre className="bg-slate-950 text-slate-50 p-4 pt-12 rounded-xl text-xs font-mono overflow-x-auto border border-slate-800 shadow-inner min-h-[100px] whitespace-pre-wrap break-all">
                    {getEmbedCode()}
                  </pre>
                </div>
                <div className="bg-gradient-to-r from-violet-50 to-indigo-50 dark:from-violet-900/20 dark:to-indigo-900/20 p-3 rounded-xl border border-violet-200/50 dark:border-violet-800/50">
                  <p className="text-xs text-violet-700 dark:text-violet-300 flex items-start gap-2">
                    <Sparkles className="w-4 h-4 flex-shrink-0 mt-0.5" />
                    <span>Paste this code anywhere in your HTML. Works with any website builder!</span>
                  </p>
                </div>
              </div>
            </div>

            {/* Right Column: Live Preview */}
            <div className="flex-1 bg-slate-100 dark:bg-slate-950 flex flex-col overflow-hidden relative min-h-[300px] lg:min-h-0">
              <div className="p-3 border-b flex justify-between items-center bg-white dark:bg-slate-900">
                <div className="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex items-center gap-2">
                  <Eye className="w-3 h-3" /> Live Preview
                </div>
                <Badge variant="secondary" className="text-xs">
                  Approved testimonials only
                </Badge>
              </div>
              
              <div className="flex-1 p-3 sm:p-4 overflow-hidden flex items-center justify-center">
                <div className="w-full h-full bg-white dark:bg-slate-900 rounded-xl shadow-lg border overflow-hidden">
                  <iframe 
                    key={`${selectedSpaceId}-${embedTheme}-${embedLayout}`} 
                    src={getPreviewUrl()}
                    width="100%" 
                    height="100%" 
                    className="w-full h-full"
                    title="Widget Preview"
                  />
                </div>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <ProfileModal 
        isOpen={isProfileModalOpen} 
        onClose={() => setIsProfileModalOpen(false)}
        user={user} 
        profile={profile} 
        onProfileUpdate={refreshProfile} 
      />
    </div>
  );
};

export default Dashboard;